services:
  dut:
    build:
      context: .
      dockerfile: Dockerfile.dut
    ports:
      - "9000:9000"
    environment:
      - MTAP_HOST=0.0.0.0
      - MTAP_DUT_PORT=9000
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.create_connection(('127.0.0.1',9000),timeout=1); s.close()\""]
      interval: 2s
      timeout: 2s
      retries: 10
      start_period: 3s

  runner:
    build:
      context: .
      dockerfile: Dockerfile.runner
    depends_on:
      dut:
        condition: service_healthy
    environment:
      - MTAP_HOST=dut
      - MTAP_DUT_PORT=9000
      - MTAP_TIMEOUT_S=2.0
    volumes:
      - ./runs:/app/runs
    command: >
      python -m mtap.cli.run_batch
      --batch-id CI_BATCH
      --station-id CI_STATION
      --sns SN0001
      --stage DVT
      --plan test_framework/test_plan.yaml
